# Copyright Â© 2025 Sierra Labs LLC
# SPDX-License-Identifier: AGPL-3.0-only
# License-Filename: LICENSE

# Redis Configuration for Blueplane Telemetry Core
# Message Queue and CDC Streams

redis:
  # Connection settings
  host: localhost
  port: 6379
  db: 0

  # Connection pool configuration
  connection_pool:
    max_connections: 10
    socket_timeout: 5.0           # Increased to 5s (must be > block_ms)
    socket_connect_timeout: 2.0   # Increased to 2s for initial connection
    retry_on_timeout: true        # Retry on timeout
    health_check_interval: 30

  # Performance tuning
  decode_responses: false  # We handle encoding/decoding
  socket_keepalive: true
  socket_keepalive_options:
    TCP_KEEPIDLE: 60
    TCP_KEEPINTVL: 10
    TCP_KEEPCNT: 3

# Stream configurations
streams:
  # Main message queue from Layer 1 capture
  message_queue:
    name: telemetry:events
    consumer_group: processors
    consumer_name_prefix: fast-path
    max_length: 10000
    trim_approximate: true
    block_ms: 1000  # Block for 1 second on XREADGROUP
    count: 100  # Read up to 100 messages at a time
    retry_timeout_ms: 300000  # 5 minutes before retry

  # Dead Letter Queue for failed messages
  dlq:
    name: telemetry:dlq
    retention_days: 7
    max_length: 1000
    trim_approximate: true

  # Change Data Capture stream for async workers
  cdc:
    name: cdc:events
    consumer_group: workers
    consumer_name_prefix: worker
    max_length: 100000
    trim_approximate: true
    block_ms: 1000
    count: 10  # Process fewer at a time for slow path
    retry_timeout_ms: 600000  # 10 minutes before retry

# Worker pool configuration
workers:
  metrics:
    count: 2  # Number of metrics workers
    enabled: true
  # Future: conversation, ai_insights workers

# Monitoring and health checks
monitoring:
  health_check_enabled: true
  health_check_interval_seconds: 60
  queue_depth_warning_threshold: 5000
  queue_depth_critical_threshold: 8000
  lag_warning_ms: 10000  # Warn if lag > 10 seconds
  lag_critical_ms: 60000  # Critical if lag > 1 minute

# Logging configuration
logging:
  level: INFO
  format: json
  include_context: true
