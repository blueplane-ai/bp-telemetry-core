#!/bin/bash
# Copyright Â© 2025 Sierra Labs LLC
# SPDX-License-Identifier: AGPL-3.0-only
# License-Filename: LICENSE

# Blueplane Telemetry - Git Post-Commit Hook
# Captures commit metadata and sends to telemetry server via HTTP
#
# This hook is designed to be non-blocking and fail silently.
# It will NEVER interfere with git operations.

# Configuration (via environment or defaults)
BLUEPLANE_SERVER_URL="${BLUEPLANE_SERVER_URL:-http://127.0.0.1:8787}"
BLUEPLANE_HOOK_TIMEOUT="${BLUEPLANE_HOOK_TIMEOUT:-0.1}"

# Run in background to not block git
(
    # Extract commit info using git commands
    COMMIT_HASH=$(git rev-parse HEAD 2>/dev/null) || exit 0
    AUTHOR_NAME=$(git log -1 --format='%an' 2>/dev/null) || exit 0
    AUTHOR_EMAIL=$(git log -1 --format='%ae' 2>/dev/null) || exit 0
    COMMIT_TIMESTAMP=$(git log -1 --format='%aI' 2>/dev/null) || exit 0
    COMMIT_MESSAGE=$(git log -1 --format='%s' 2>/dev/null | head -c 500) || exit 0
    BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null) || exit 0

    # Get diff stats (summary only)
    DIFF_STATS=$(git diff-tree --shortstat -r HEAD 2>/dev/null || echo "")
    FILES_CHANGED=$(echo "$DIFF_STATS" | grep -oE '[0-9]+ file' | grep -oE '[0-9]+' || echo "0")
    INSERTIONS=$(echo "$DIFF_STATS" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
    DELETIONS=$(echo "$DIFF_STATS" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")

    # Get workspace/repo info
    REPO_PATH=$(git rev-parse --show-toplevel 2>/dev/null) || exit 0
    REMOTE_URL=$(git config --get remote.origin.url 2>/dev/null || echo "")

    # Compute workspace hash (SHA256 of repo path, first 16 chars)
    if command -v sha256sum &>/dev/null; then
        WORKSPACE_HASH=$(echo -n "$REPO_PATH" | sha256sum | cut -c1-16)
    elif command -v shasum &>/dev/null; then
        WORKSPACE_HASH=$(echo -n "$REPO_PATH" | shasum -a 256 | cut -c1-16)
    else
        # Fallback - shouldn't happen on modern systems
        exit 0
    fi

    # Get project name (directory name)
    PROJECT_NAME=$(basename "$REPO_PATH")

    # Current timestamp for event (ISO 8601 UTC)
    TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u +"%Y-%m-%dT%H:%M:%SZ")

    # Escape commit message for JSON (handle special characters)
    # Simple approach: use Python if available for proper JSON escaping
    if command -v python3 &>/dev/null; then
        ESCAPED_MESSAGE=$(python3 -c "import json,sys; print(json.dumps('$COMMIT_MESSAGE'))" 2>/dev/null || echo '""')
    else
        # Fallback: basic escaping (may not handle all special chars)
        ESCAPED_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
        ESCAPED_MESSAGE="\"$ESCAPED_MESSAGE\""
    fi

    # Build JSON payload
    read -r -d '' PAYLOAD <<'EOF' || true
{
    "event": {
        "hook_type": "GitPostCommit",
        "event_type": "git_commit",
        "timestamp": "%TIMESTAMP%",
        "payload": {
            "commit_hash": "%COMMIT_HASH%",
            "author_name": "%AUTHOR_NAME%",
            "author_email": "%AUTHOR_EMAIL%",
            "commit_timestamp": "%COMMIT_TIMESTAMP%",
            "commit_message": %ESCAPED_MESSAGE%,
            "files_changed": %FILES_CHANGED%,
            "insertions": %INSERTIONS%,
            "deletions": %DELETIONS%,
            "branch_name": "%BRANCH_NAME%",
            "repo_path": "%REPO_PATH%",
            "remote_url": "%REMOTE_URL%"
        },
        "metadata": {
            "workspace_hash": "%WORKSPACE_HASH%",
            "workspace_path": "%REPO_PATH%",
            "project_name": "%PROJECT_NAME%"
        }
    },
    "platform": "git",
    "session_id": "git-%WORKSPACE_HASH%"
}
EOF

    # Replace placeholders in payload
    PAYLOAD="${PAYLOAD//\%TIMESTAMP\%/$TIMESTAMP}"
    PAYLOAD="${PAYLOAD//\%COMMIT_HASH\%/$COMMIT_HASH}"
    PAYLOAD="${PAYLOAD//\%AUTHOR_NAME\%/$AUTHOR_NAME}"
    PAYLOAD="${PAYLOAD//\%AUTHOR_EMAIL\%/$AUTHOR_EMAIL}"
    PAYLOAD="${PAYLOAD//\%COMMIT_TIMESTAMP\%/$COMMIT_TIMESTAMP}"
    PAYLOAD="${PAYLOAD//\%ESCAPED_MESSAGE\%/$ESCAPED_MESSAGE}"
    PAYLOAD="${PAYLOAD//\%FILES_CHANGED\%/$FILES_CHANGED}"
    PAYLOAD="${PAYLOAD//\%INSERTIONS\%/$INSERTIONS}"
    PAYLOAD="${PAYLOAD//\%DELETIONS\%/$DELETIONS}"
    PAYLOAD="${PAYLOAD//\%BRANCH_NAME\%/$BRANCH_NAME}"
    PAYLOAD="${PAYLOAD//\%REPO_PATH\%/$REPO_PATH}"
    PAYLOAD="${PAYLOAD//\%REMOTE_URL\%/$REMOTE_URL}"
    PAYLOAD="${PAYLOAD//\%WORKSPACE_HASH\%/$WORKSPACE_HASH}"
    PAYLOAD="${PAYLOAD//\%PROJECT_NAME\%/$PROJECT_NAME}"

    # Send to server (fire-and-forget)
    # Using curl with very short timeout and background execution
    if command -v curl &>/dev/null; then
        curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            --connect-timeout "$BLUEPLANE_HOOK_TIMEOUT" \
            --max-time 1 \
            "$BLUEPLANE_SERVER_URL/events" \
            >/dev/null 2>&1
    elif command -v wget &>/dev/null; then
        echo "$PAYLOAD" | wget -q -O- \
            --timeout=1 \
            --post-data=- \
            --header="Content-Type: application/json" \
            "$BLUEPLANE_SERVER_URL/events" \
            >/dev/null 2>&1
    fi
) &

# Always exit successfully - never block git
exit 0
